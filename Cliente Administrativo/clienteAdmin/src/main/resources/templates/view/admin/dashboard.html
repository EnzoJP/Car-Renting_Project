<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Dashboard - SB Admin</title>

    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/aos.css}">
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
</head>

<body class="sb-nav-fixed">

<nav th:replace="~{view/admin/components/navbarUs :: navbar_usuario}"></nav>

<div id="layoutSidenav">
    <div id="layoutSidenav_nav">
        <nav th:replace="~{view/admin/components/sidebar :: sidebar}"></nav>
    </div>

    <div id="layoutSidenav_content">
        <main>
            <div class="container-fluid px-4">
                <h1 class="mt-4">Dashboard</h1>
                <ol class="breadcrumb mb-4">
                    <li class="breadcrumb-item active">Bienvenido admin :) </li>
                </ol>

                <div class="row">
                    <div class="col-xl-3 col-md-6">
                        <th:block th:replace="~{view/admin/components/cards :: card('success', 'Gestión de Vehículos', @{/admin/vehiculo/menu})}"></th:block>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <th:block th:replace="~{view/admin/components/cards :: card('primary', 'ABM Direcciones', @{/admin/direccion/menu})}"></th:block>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <th:block th:replace="~{view/admin/components/cards :: card('warning', 'Gestión de Usuarios', @{/admin/usuarios/menu})}"></th:block>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <th:block th:replace="~{view/admin/components/cards :: card('danger', 'Gestión de Alquileres', @{/admin/alquiler/list})}"></th:block>
                    </div>
                </div>


                <div class="row">
                    <div class="col-xl-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-chart-pie me-1"></i>
                                Estado de la Flota (En Vivo)
                            </div>
                            <div class="card-body">
                                <canvas id="myPieChart" width="100%" height="40"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-chart-bar me-1"></i>
                                Crecimiento de Clientes primer semestre
                            </div>
                            <div class="card-body">
                                <canvas id="myBarChart" width="100%" height="40"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-table me-1"></i>
                        Actividad Reciente (Últimos 5 Alquileres)
                    </div>
                    <div class="card-body">
                        <table id="datatablesSimple">
                            <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Vehículo</th>
                                <th>Fecha Desde</th>
                                <th>Fecha Hasta</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="alquiler : ${actividadReciente}">
                                <td th:text="${alquiler.cliente?.apellido} + ', ' + ${alquiler.cliente?.nombre}"></td>
                                <td th:text="${alquiler.vehiculo?.caracteristicaVehiculo?.modelo} + ' (' + ${alquiler.vehiculo?.patente} + ')'"></td>
                                <td th:text="${#dates.format(alquiler.fechaDesde, 'dd/MM/yyyy')}"></td>
                                <td th:text="${#dates.format(alquiler.fechaHasta, 'dd/MM/yyyy')}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>

        <div th:replace="~{components/footer :: footer}"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/scripts.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>

<script th:src="@{/assets/demo/chart-bar-demo.js}"></script> <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
<script th:src="@{/js/datatables-simple-demo.js}"></script>


<script th:inline="javascript">
    /*<![CDATA[*/

    // Obtenemos los datos del modelo de Spring
    const disponibles = /*[[ ${disponibles} ]]*/;
    const alquilados = /*[[ ${alquilados} ]]*/;
    const mantenimiento = /*[[ ${mantenimiento} ]]*/;
    const total = disponibles + alquilados + mantenimiento;

    // --- Chart.js Pie Chart ---
    Chart.defaults.global.defaultFontFamily = '-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif';
    Chart.defaults.global.defaultFontColor = '#292b2c';

    var ctx = document.getElementById("myPieChart");
    var myPieChart = new Chart(ctx, {
        type: 'doughnut', // 'doughnut' se ve un poco más moderno que 'pie'
        data: {
            labels: ["Disponibles", "Alquilados", "En Mantenimiento"],
            datasets: [{
                data: [disponibles, alquilados, mantenimiento],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'], // Verde, Amarillo, Rojo
            }],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    boxWidth: 20
                }
            },
            plugins: {
                datalabels: {
                    color: '#fff',
                    formatter: (value, context) => {
                        if (value === 0) return '';
                        let percentage = ((value / total) * 100).toFixed(0) + "%";
                        return percentage;
                    }
                }
            }
        }
    });

    /*]]>*/
</script>

<script>
    // Tu script de Bootstrap para el sidebar (¡importante!)
    document.addEventListener('DOMContentLoaded', function() {
        const accordions = document.querySelectorAll('#sidenavAccordion .collapse');
        accordions.forEach(el => {
            if (!el.classList.contains('show')) {
                new bootstrap.Collapse(el, { toggle: false });
            }
        });
    });
</script>
</body>
</html>